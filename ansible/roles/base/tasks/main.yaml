# - name: Ubuntu - Update APT
#   apt:
#     update_cache: yes
#     cache_valid_time: 86400

- set_fact: centOS="{{ ansible_distribution == "CentOS" }}"

- name: System updates
  include_role:
    name: base
    tasks_from: systemUpdate.yml

- name: Before Install
  shell: |
    yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
    yum-config-manager --enable docker-ce-edge
    yum -y install epel-release
    yum -y update
    yum groupinstall "development tools" -y
    yum install openssl-devel libffi-devel bzip2-devel -y
    yum install python3-devel python3 -y
  when: centOS
  ignore_errors: true

- name: Install packages
  package:
    name: "{{ packages }}"
    state: present
  vars:
    packages:
      - "{{ 'java-1.8.0-openjdk' if centOS else 'openjdk-11-jdk' }}"
      - "{{ (centOS) | ternary('python3-pip', 'python3-pip') }}"
      - net-tools
      - nmap
      - tree
      - wget
      - openssl
      - "{{ (centOS) | ternary('tree', 'apt-transport-https') }}"
      - "{{ (centOS) | ternary('yum-utils', 'tree') }}"
      - "{{ (centOS) | ternary('device-mapper-persistent-data', 'tree') }}"
      - "{{ (centOS) | ternary('lvm2', 'tree') }}"
      - curl
      - "{{ 'docker.io' if not centOS else 'docker-ce'}}"
  ignore_errors: true

- set_fact: centOSPythonVersion="3.10.2"

# - name: download latest Python-{{ centOSPythonVersion }} and install 
#   shell: |
    # wget https://www.python.org/ftp/python/{{ centOSPythonVersion }}/Python-{{ centOSPythonVersion }}.tgz
    # wget https://bootstrap.pypa.io/get-pip.py
    # tar -xzf Python-{{ centOSPythonVersion }}.tgz
    # cd Python-{{ centOSPythonVersion }}
    # ./configure --enable-optimizations || true
    # make
    # make altinstall || true
    # # cp python /usr/bin/python-{{ centOSPythonVersion }}
    # ln -s /usr/bin/python-{{ centOSPythonVersion }} /usr/bin/python
    # python get-pip.py
  # no_log: true
  # ignore_errors: true
  # when: centOS
  
# - name: Clean
#   shell: "rm -fr ~/{{ item }}"
#   with_items:
#   - "Python*"
#   - "get-pip*"
#   when: centOS

- name: pip3 packages
  ansible.builtin.pip:
    name:
    - lxml
    - ssh_config
    - stormssh

- name: Hostname
  tags: ["base", "always"]
  include_role:
    name: base
    tasks_from: hosts.yml

- name: Touch env file
  file:
    mode: 0755
    path: "{{ ENV_FILE_SOURCE }}"
    state: touch

- name: Set {{ ENV_FILE_SOURCE }} for all user
  blockinfile:
    insertafter: EOF
    dest: "{{ ENV_FILE_SOURCE }}"
    block: |
      export {{ item.name }}="{{ item.line }}"
    marker: "\n# {mark} Ansible manage block {{ item.name }}"
    backup: true
  with_items:
    - { name: "JAVA_HOME", line: "{{ JAVA_HOME }}" }
    - { name: "HADOOP_HOME", line: "{{ HADOOP_HOME }}" }
    - { name: "HBASE_HOME", line: "{{ HBASE_HOME }}" }
    - { name: "ZK_HOME", line: "{{ ZK_HOME }}" }
    - { name: "KAFKA_HOME", line: "{{ KAFKA_HOME }}" }
    - { name: "HDFS_NAMENODE_USER", line: "root" }
    - { name: "HDFS_DATANODE_USER", line: "root" }
    - { name: "HDFS_SECONDARYNAMENODE_USER", line: "root" }
    - { name: "YARN_RESOURCEMANAGER_USER", line: "root" }
    - { name: "YARN_NODEMANAGER_USER", line: "root" }
    - { name: "HBASE_MANAGES_ZK", line: "{{ HBASE_MANAGES_ZK }}" }
    - { name: "HADOOP_CLASSPATH", line: "${JAVA_HOME}/lib/tools.jar" }
    - {
        name: "PATH",
        line: "$PATH:$JAVA_HOME/bin:$HADOOP_HOME/sbin:$HADOOP_HOME/bin:{{ HBASE_HOME }}/bin:$ZK_HOME/bin:$KAFKA_HOME/bin",
      }

- name: Config Remote SSH
  tags: ["base", "always"]
  include_role:
    name: base
    tasks_from: ssh-servers.yml

- name: Config Local SSH
  when: inventory_hostname == groups['nodes'][0]
  tags: ["base", "always"]
  include_role:
    name: base
    tasks_from: ssh-local.yml

- name: Add docker group
  group:
    name: "docker"
    state: present

- name: "add ubuntu to docker group"
  user:
    name: "ubuntu"
    groups: ["docker"]
    append: yes
  ignore_errors: true

- name: add  {{ K8S_USER }}  to docker group
  user:
    name: "{{ K8S_USER }}"
    groups: ["docker"]
    append: yes
  ignore_errors: true
  when: K8S_USER != OS_USER

- name: AWS - uninstall amazon-ssm-agent
  shell: "snap remove amazon-ssm-agent"

- name: Reboot
  include_role:
    name: base
    tasks_from: reboot.yml

- name: Set timezone
  timezone:
    name: "Asia/Taipei"